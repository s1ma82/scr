import{k as L,r as d,u as B,l as U,y as q,g as K,A,a as M,q as z,j as e,E as H,S as I,B as V,z as X,t as G,n as Q}from"./index-q8pKR0Np.js";import{E as W}from"./Edit-Ck39ugGG.js";import{E as Y}from"./EditOff-ByS42Xqf.js";import{A as E}from"./Add-BUmwIqbg.js";import{u as Z,s as o,S as tt}from"./SaveAs-BqTmnDMN.js";import{I as w,T as u}from"./Tooltip-_6qUQ1et.js";import{g as et,F as st,S as nt}from"./getToolbarItems-CwMbFx6A.js";import"./NoteAdd-C6-2wMnV.js";const j={type:"doc",content:[]},$=4,ut=()=>{var _;const{id:h}=L(),[C,N]=d.useState(!1),{focusedArticles:y}=B(s=>s.catalogs),D=U(),[g,k]=q(),T=Number(g.get("row"))||0,O=Number(g.get("column"))||0,[S,p]=Z({title:"",author:""}),[n,m]=d.useState(null),[r,v]=d.useState(T),[i,b]=d.useState(O),[f,J]=d.useState(!0);d.useEffect(()=>{n&&k({row:r,column:i})},[r,i,n]),d.useEffect(()=>{console.log("Загрузка данных статьи "),h&&(async()=>{try{const s=y.find(a=>a.id===h);if(s){const a=await K(s.content);Array.isArray(a)?m(a):(console.error("Некорректный формат данных из Files.get:",a),m([[j]])),p("",{title:s.title,author:s.author});return}const t=await A.getArticle(h);D(M(t)),Array.isArray(t.content)?m(t.content):(console.error("Некорректный формат данных из Admin.getArticle:",t.content),m([[j]])),p("",{title:t.title,author:t.author})}catch(s){console.error("Ошибка при загрузке статьи:",s),m([[j]])}})()},[h,y]);const c=z({extensions:G,content:n&&n[r]&&n[r][i]?n[r][i]:j,onUpdate:({editor:s})=>{const t=s.getJSON();m(a=>{if(!a||!a[r])return a;const x=[...a];return x[r]=[...x[r]],x[r][i]=t,N(!0),x})},editorProps:{handleKeyDown(s,t){return t.ctrlKey&&t.key==="Enter"?(s.dispatch(s.state.tr.insertText(`
`)),t.preventDefault(),!0):!1}}});d.useEffect(()=>{if(c&&n&&n[r]&&n[r][i]){const s=n[r][i],t=c.getJSON();if(JSON.stringify(s)!==JSON.stringify(t)){const a=c.state.selection;c.commands.setContent(s,!1),a&&c.commands.setTextSelection(a)}}},[r,i,n,c]),d.useEffect(()=>{const s=t=>{C&&(t.preventDefault(),t.returnValue="")};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[C]);const P=()=>{m(s=>{const t=[...s,[j]];return v(t.length-1),b(0),t})},R=()=>{m(s=>{const t=[...s],a=t[r];return a.length<$&&(t[r]=[...a,j]),t})},F=async()=>{if(!h||!n)return;const s={id:h,title:S("title"),content:n};try{const t=await A.saveArticle(s);N(!1),Q()}catch(t){console.error("Ошибка при сохранении:",t)}};if(!n)return e.jsx("div",{children:"Загрузка данных..."});if(!c)return null;const l=et({editor:c,styles:o});return e.jsxs("div",{className:o.tiptapeditor,children:[e.jsx(w,{name:"title",className:o.name,placeholder:"Введи название для справки",onChange:s=>p(s.currentTarget.name,s.currentTarget.value),value:S("title")}),e.jsxs("div",{className:o.toolbar,children:[e.jsx("div",{className:o.toolbar_section,children:l.slice(0,2).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},t))},"section-1"),e.jsx("div",{className:o.toolbar_section,children:l.slice(2,5).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#1`))},"section-2"),e.jsx("div",{className:o.toolbar_section,children:l.slice(5,8).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#2`))},"section-3"),e.jsxs("div",{className:o.toolbar_section,children:[l.slice(8,10).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#3`)),e.jsx(w,{className:l[9].className,title:l[9].name,onChange:l[9].onChange,type:"file",children:l[9].children})]},"section-4"),e.jsx("div",{className:o.toolbar_section,children:l.slice(11,15).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#4`))},"section-5"),e.jsx("div",{className:o.toolbar_section,children:e.jsx(st,{control:e.jsx(nt,{checked:f,onChange:()=>J(!f),color:"primary"}),label:f?e.jsx(W,{}):e.jsx(Y,{})})})]}),e.jsxs("div",{className:`${o.toolbar} ${o.toolbar_sub}`,children:[e.jsxs("div",{className:o.toolbar_section,children:[Array.isArray(n)?n.map((s,t)=>e.jsx(u,{title:`Строка ${t+1}`,children:e.jsx("button",{className:`${o.toolbar__item} ${r===t&&o.active}`,onClick:()=>{v(t),b(0)},children:t+1})},t)):e.jsx("div",{children:"Ошибка: данные не загружены"}),e.jsx("div",{className:o.toolbar_section,children:e.jsxs("button",{className:`${o.toolbar__item}`,onClick:P,children:[e.jsx(E,{}),"Новая строка"]})})]}),e.jsxs("div",{className:o.toolbar_section,children:[Array.isArray(n)&&n[r]?n[r].map((s,t)=>e.jsx(u,{title:`Столбец ${t+1}`,children:e.jsx("button",{className:`${o.toolbar__item} ${i===t&&o.active}`,onClick:()=>b(t),children:t+1})},t)):e.jsx("div",{children:"Ошибка: данные строки не загружены"}),Array.isArray(n)&&((_=n[r])==null?void 0:_.length)<$&&e.jsx("div",{className:o.toolbar_section,children:e.jsxs("button",{className:`${o.toolbar__item}`,onClick:R,children:[e.jsx(E,{}),"Новый столбец"]})})]})]}),f&&n?e.jsx(H,{editor:c,className:"tiptap_content"}):e.jsx("pre",{children:JSON.stringify(n[r][i],null,2)}),e.jsx(I,{data:n,columns:4}),e.jsx("div",{className:o.toolbar,children:e.jsxs(V,{onClick:F,className:o.submit_menu__item,children:[e.jsx(tt,{}),"Сохранить изменения"]})}),isDev&&e.jsx(X,{sx:{mt:2,p:2,backgroundColor:"var(--blue-admin-alt-color)",color:"var(--white-color)"},children:e.jsx("pre",{children:JSON.stringify(n,null,2)})})]})};export{ut as default};
