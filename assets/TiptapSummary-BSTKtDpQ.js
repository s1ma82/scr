import{l as L,r as m,u as B,m as K,Z as U,g as M,A,a as q,K as G,j as e,N as H,S as I,$ as V,t as X,G as Z}from"./index-BYT0V1gO.js";import{E as z}from"./Edit-BXfskQEj.js";import{E as Q}from"./EditOff-DZC3g9ZT.js";import{A as E}from"./Add-DfPP2A7M.js";import{u as W,s as o,S as Y}from"./SaveAs-B3kR1vHY.js";import{B as tt}from"./index-BYWxSTIH.js";import{I as w,T as u}from"./Tooltip-Dkvm1Azr.js";import{g as et,F as st,S as nt}from"./getToolbarItems-DVLZice8.js";import"./NoteAdd-BSkyQwFr.js";const f={type:"doc",content:[]},$=4,ht=()=>{var _;const{id:h}=L(),[N,C]=m.useState(!1),{focusedArticles:y}=B(s=>s.catalogs),D=K(),[g,T]=U(),k=Number(g.get("row"))||0,O=Number(g.get("column"))||0,[S,p]=W({title:"",author:""}),[n,d]=m.useState(null),[r,v]=m.useState(k),[i,b]=m.useState(O),[j,J]=m.useState(!0);m.useEffect(()=>{n&&T({row:r,column:i})},[r,i,n]),m.useEffect(()=>{console.log("Загрузка данных статьи "),h&&(async()=>{try{const s=y.find(a=>a.id===h);if(s){const a=await M(s.content);Array.isArray(a)?d(a):(console.error("Некорректный формат данных из Files.get:",a),d([[f]])),p("",{title:s.title,author:s.author});return}const t=await A.getArticle(h);D(q(t)),Array.isArray(t.content)?d(t.content):(console.error("Некорректный формат данных из Admin.getArticle:",t.content),d([[f]])),p("",{title:t.title,author:t.author})}catch(s){console.error("Ошибка при загрузке статьи:",s),d([[f]])}})()},[h,y]);const c=G({extensions:X,content:n&&n[r]&&n[r][i]?n[r][i]:f,onUpdate:({editor:s})=>{const t=s.getJSON();d(a=>{if(!a||!a[r])return a;const x=[...a];return x[r]=[...x[r]],x[r][i]=t,C(!0),x})},editorProps:{handleKeyDown(s,t){return t.ctrlKey&&t.key==="Enter"?(s.dispatch(s.state.tr.insertText(`
`)),t.preventDefault(),!0):!1}}});m.useEffect(()=>{if(c&&n&&n[r]&&n[r][i]){const s=n[r][i],t=c.getJSON();if(JSON.stringify(s)!==JSON.stringify(t)){const a=c.state.selection;c.commands.setContent(s,!1),a&&c.commands.setTextSelection(a)}}},[r,i,n,c]),m.useEffect(()=>{const s=t=>{N&&(t.preventDefault(),t.returnValue="")};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[N]);const P=()=>{d(s=>{const t=[...s,[f]];return v(t.length-1),b(0),t})},R=()=>{d(s=>{const t=[...s],a=t[r];return a.length<$&&(t[r]=[...a,f]),t})},F=async()=>{if(!h||!n)return;const s={id:h,title:S("title"),content:n};try{const t=await A.saveArticle(s);C(!1),Z()}catch(t){console.error("Ошибка при сохранении:",t)}};if(!n)return e.jsx("div",{children:"Загрузка данных..."});if(!c)return null;const l=et({editor:c,styles:o});return e.jsxs("div",{className:o.tiptapeditor,children:[e.jsx(w,{name:"title",className:o.name,placeholder:"Введи название для справки",onChange:s=>p(s.currentTarget.name,s.currentTarget.value),value:S("title")}),e.jsxs("div",{className:o.toolbar,children:[e.jsx("div",{className:o.toolbar_section,children:l.slice(0,2).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},t))},"section-1"),e.jsx("div",{className:o.toolbar_section,children:l.slice(2,5).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#1`))},"section-2"),e.jsx("div",{className:o.toolbar_section,children:l.slice(5,8).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#2`))},"section-3"),e.jsxs("div",{className:o.toolbar_section,children:[l.slice(8,10).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#3`)),e.jsx(w,{className:l[9].className,title:l[9].name,onChange:l[9].onChange,type:"file",children:l[9].children})]},"section-4"),e.jsx("div",{className:o.toolbar_section,children:l.slice(11,15).map((s,t)=>e.jsx(u,{title:s.name,children:e.jsx("button",{...s})},`${t}#4`))},"section-5"),e.jsx("div",{className:o.toolbar_section,children:e.jsx(st,{control:e.jsx(nt,{checked:j,onChange:()=>J(!j),color:"primary"}),label:j?e.jsx(z,{}):e.jsx(Q,{})})})]}),e.jsxs("div",{className:`${o.toolbar} ${o.toolbar_sub}`,children:[e.jsxs("div",{className:o.toolbar_section,children:[Array.isArray(n)?n.map((s,t)=>e.jsx(u,{title:`Строка ${t+1}`,children:e.jsx("button",{className:`${o.toolbar__item} ${r===t&&o.active}`,onClick:()=>{v(t),b(0)},children:t+1})},t)):e.jsx("div",{children:"Ошибка: данные не загружены"}),e.jsx("div",{className:o.toolbar_section,children:e.jsxs("button",{className:`${o.toolbar__item}`,onClick:P,children:[e.jsx(E,{}),"Новая строка"]})})]}),e.jsxs("div",{className:o.toolbar_section,children:[Array.isArray(n)&&n[r]?n[r].map((s,t)=>e.jsx(u,{title:`Столбец ${t+1}`,children:e.jsx("button",{className:`${o.toolbar__item} ${i===t&&o.active}`,onClick:()=>b(t),children:t+1})},t)):e.jsx("div",{children:"Ошибка: данные строки не загружены"}),Array.isArray(n)&&((_=n[r])==null?void 0:_.length)<$&&e.jsx("div",{className:o.toolbar_section,children:e.jsxs("button",{className:`${o.toolbar__item}`,onClick:R,children:[e.jsx(E,{}),"Новый столбец"]})})]})]}),j&&n?e.jsx(H,{editor:c,className:"tiptap_content"}):e.jsx("pre",{children:JSON.stringify(n[r][i],null,2)}),e.jsx(I,{data:n,columns:4}),e.jsx("div",{className:o.toolbar,children:e.jsxs(tt,{onClick:F,className:o.submit_menu__item,children:[e.jsx(Y,{}),"Сохранить изменения"]})}),isDev&&e.jsx(V,{sx:{mt:2,p:2,backgroundColor:"var(--blue-admin-alt-color)",color:"var(--white-color)"},children:e.jsx("pre",{children:JSON.stringify(n,null,2)})})]})};export{ht as default};
